# Работа с Trino (Cedrus): SELECT и DESCRIBE

## Требования
- Docker Compose
- Python 3.11+
- Java: Temurin JDK 21  
  Установка на macOS: `brew install temurin@21`  
  Если после установки `java` не виден в PATH, добавьте в профиль оболочки:  
  - zsh: `export PATH="/Library/Java/JavaVirtualMachines/temurin-21.jdk/Contents/Home/bin:$PATH"`  
  - или через `java_home`:  
    `export JAVA_HOME=$(/usr/libexec/java_home -v 21)`  
    `export PATH="$JAVA_HOME/bin:$PATH"`

## Быстрый старт
1. Подготовка `.env`: скопируйте `.env.example` в `.env` и при необходимости поправьте порты/логины/пароли. По умолчанию в `.env`: Trino наружу 6100, MinIO 6110/6111 (креды `superadmin/superadmin`), Postgres 6120 (`superadmin/superadmin`).
2. Запускаем контейнеры:  
   `docker compose up -d`  
   Данные пишутся в `./data/minio` и `./data/postgres`. Сеть создается как `dwh-platform-net`.
   При первом старте Postgres инициализирует базу `metalake` и таблицы Iceberg метаданных (скрипт `scripts/init_pg.sql`).
   MinIO инициализируется сервисом `minio-init` (minio/mc) и создаёт бакет `${DWH_BUCKET:-dwh}` автоматически.
3. Создаем Python-окружение:  
   `python -m venv .venv`  
   `source .venv/bin/activate` (Linux/Mac) или `.venv\Scripts\activate` (Windows)
4. Устанавливаем зависимости:  
   `pip install --upgrade pip`  
   `pip install -r requirements.txt`
5. Запускаем пример:  
   `python main.py`  
   В консоли отобразится вывод DESCRIBE и затем строки из SELECT.

## Что умеет клиент
- SELECT-запросы: `TrinoService.execute(sql)` → `TrinoQueryResult` (поля: `columns`, `data`)
- DESCRIBE: `TrinoService.describe(object_name)` → `list[DescribeRow]` (pydantic-модели)

## Логирование
- Уровень настраивается через `setup_logging(level=…)`: `DEBUG`, `INFO`, `WARNING`, `ERROR`
- `DEBUG` показывает сетевые запросы, страницы, статистику выполнения и подробные логи клиента

## Конфигурация Trino
- Файлы `configs/config.properties` и `configs/dwh.properties` используют встроенную подстановку переменных Trino вида `${ENV:VAR}`.
- Значения берутся из окружения контейнера (заданы в `.env` и проброшены через `docker-compose.yml`).
- Никакой дополнительной генерации конфигов не требуется: Trino сам подставит значения при старте.

Примечание по Postgres: скрипт `scripts/init_pg.sql` выполняется только при первичной инициализации volume `./data/postgres`. Если вы меняли volume или чистили данные, убедитесь, что база `metalake` существует, либо выполните команды из скрипта вручную.
